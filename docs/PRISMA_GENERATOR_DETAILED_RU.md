# Подробная документация Prisma генератора

## Анализ архитектуры

Prisma NestJS DTO Генератор - это сложный инструмент генерации кода, который преобразует определения схемы Prisma в полностью готовые к production NestJS приложения с интеграцией React Admin фронтенда.

## Основная архитектура

### Точка входа (`src/index.ts`)
Основной обработчик генератора, который обрабатывает схему Prisma и координирует конвейер генерации:

```typescript
generatorHandler({
  onManifest: () => ({
    defaultOutput: '../src/generated/nestjs-dto',
    prettyName: 'NestJS DTO Generator',
  }),
  onGenerate: generate,
});
```

### Обработка конфигурации
Поддерживает обширные опции конфигурации:
- **Соглашения об именовании**: camel, pascal, snake, kebab регистры
- **Типы вывода**: классы против интерфейсов
- **Валидация**: интеграция class-validator
- **Структура**: плоская против вложенной организации ресурсов
- **Генерация фронтенда**: компоненты React Admin и провайдеры данных

### Конвейер генерации (`src/generator/index.ts`)
Координирует генерацию нескольких типов артефактов:
- DTO классы (Create, Update, Plain)
- Entity классы
- Контроллеры с полными CRUD операциями
- Сервисы для бизнес-логики
- Формы фронтенда и провайдеры данных
- Enums и определения типов

## Ключевые модули генерации

### 1. Генерация контроллеров (`generate-controller.ts`)
Генерирует полные NestJS REST контроллеры с:

**Возможности:**
- Полные CRUD операции (GET, POST, PUT, DELETE)
- Документация Swagger с правильными аннотациями
- Автоматическая пагинация и сортировка
- Поддержка мягкого удаления для моделей с `deletedAt`
- Интеграция контекста пользователя для моделей с `userId`
- Валидация параметров UUID
- Поддержка транзакций для атомарных операций

**Генерируемые эндпоинты:**
```typescript
@Controller('api/model-name')
export class ModelNameController {
  @Get() findMany()        // Список с пагинацией
  @Post() createOne()      // Создание новой записи
  @Get(':id') findOne()    // Получение по ID
  @Put(':id') updateOne()  // Обновление существующей
  @Delete(':id') deleteOne() // Удаление записи
}
```

### 2. Генерация форм фронтенда (`generate-form.ts`)
Создает формы React Admin с интеллектуальным сопоставлением полей:

**Интеллектуальный выбор компонентов:**
- `TextInput` для строковых полей
- `NumberInput` для числовых типов (Int, Float, Decimal)
- `BooleanInput` для булевых полей
- `DateTimeInput` для полей DateTime
- `JsonViewerField` для JSON данных с сворачиваемым просмотрщиком

**Генерируемые типы форм:**
- Формы создания (только редактируемые поля)
- Формы редактирования (редактируемые + только для чтения поля)
- Формы просмотра (все поля только для чтения)

### 3. Генерация провайдеров данных (`generate-data-provider.ts`)
Реализует полный интерфейс провайдера данных React Admin:

**Поддерживаемые операции:**
- `getList` - Получение пагинированных списков
- `getOne` - Получение одной записи
- `getMany` - Получение нескольких записей
- `getManyReference` - Получение связанных данных
- `create` - Создание новых записей
- `update` - Обновление существующих записей
- `updateMany` - Массовые обновления
- `delete` - Удаление одной записи
- `deleteMany` - Массовые удаления

### 4. Вспомогательные шаблоны (`template-helpers.ts`)
Предоставляет вспомогательные функции для:
- Преобразования соглашений об именовании
- Разрешения путей
- Генерации операторов импорта
- Согласованности именования файлов

## Расширенные возможности

### Обработка связей
Автоматически обрабатывает отношения Prisma:
- Отношения один-ко-многим
- Отношения многие-ко-многим
- Вложенные операции создания/обновления
- Валидация отношений

### Пользовательские аннотации
Поддерживает аннотации на уровне полей:
- `@DtoReadOnly` - Делает поле только для чтения в формах
- `@DtoHide` - Скрывает поле из сгенерированного кода
- `@DtoOverrideType` - Переопределяет сгенерированный тип TypeScript
- Пользовательские правила валидации

### Поддержка мягкого удаления
Автоматическая интеграция для моделей с полем `deletedAt`:
- Фильтрация удаленных записей в запросах
- Реализация мягкого удаления в операциях обновления
- Правильная обработка в представлениях списков

### Интеграция контекста пользователя
Для моделей с полем `userId`:
- Автоматическая инъекция ID пользователя в операциях создания
- Фильтрация данных по конкретному пользователю
- Распространение контекста запроса

## Возможности интеграции фронтенда

### Полный стек React Admin
Генератор создает полноценное приложение React Admin, включая:

**Слой данных:**
- Типизированные провайдеры данных для всех моделей
- Автоматическое сопоставление API эндпоинтов
- Обработка ошибок и логика повторных попыток
- Интеграция аутентификации

**Слой представления:**
- Автогенерируемые формы с соответствующими типами ввода
- Поисковые и сортируемые представления списков
- Детальные представления со всей информацией о полях
- Поддержка массовых действий

**Конфигурация:**
- Центральная регистрация ресурсов
- Маркировка меню и организация
- Контроль доступа на основе прав

### Генерируемая структура файлов
```
generated/
├── client/              # Клиентский код API
├── prisma/              # Совместимые с браузером типы Prisma
├── resource/            # Компоненты React Admin
│   ├── ModelNameDataProvider.ts
│   ├── ModelNameForm.tsx
│   ├── ModelNameList.tsx
│   └── resources.ts      # Центральный реестр ресурсов
└── rest/                # Backend DTO и контроллеры
```

## Опции конфигурации

### Настройки генератора
```prisma
generator nestjsDto {
  provider = "prisma-generator-nestjs-dto"
  
  # Конфигурация вывода
  output = "../src/generated/nestjs-dto"
  fileNamingStyle = "camel"
  outputType = "class"
  
  # Переключатели функций
  classValidation = true
  swagger = true
  generateControllers = true
  generateDataProviders = true
  generateForms = true
  
  # Интеграция фронтенда
  frontendOutput = "../frontend/src/generated"
  generateLists = true
  
  # Расширенные опции
  definiteAssignmentAssertion = false
  wrapRelationsAsType = true
  showDefaultValues = false
}
```

### Интеграция окружения
- Автоматическое обнаружение пути клиента Prisma
- Интеграция форматирования Prettier
- Совместимость с компиляцией TypeScript
- Обработка путей для разных платформ

## Оптимизации производительности

### Эффективность генерации кода
- Инкрементальная генерация (уважает DO_NOT_CHANGE_WHICH_GENERATING_CODE)
- Параллельная обработка нескольких моделей
- Экономичная по памяти манипуляция AST
- Кэширование вычисленных значений

### Качество сгенерированного кода
- Минимальный размер бандла через tree-shaking
- Оптимальные операторы импорта
- Согласованное форматирование кода
- Типобезопасные реализации

## Точки расширяемости

### Пользовательские шаблоны
Архитектура генератора позволяет:
- Пользовательские шаблоны контроллеров
- Альтернативные фронтенд фреймворки
- Разные библиотеки валидации
- Пользовательские процессоры полей

### Система плагинов
Поддержка расширения функциональности через:
- Пользовательские классификаторы полей
- Дополнительные обработчики аннотаций
- Пользовательские генераторы вывода
- Интеграция внешних инструментов

## Рабочий процесс интеграции

### Процесс разработки
1. Определить схему Prisma с моделями и отношениями
2. Настроить опции генератора в schema.prisma
3. Запустить `npx prisma generate`
4. Сгенерированный код появляется в указанных директориях вывода
5. Фронтенд автоматически подхватывает новые ресурсы

### Непрерывная интеграция
- Автоматическая регенерация при изменениях схемы
- Дружественный к системам контроля версий (четкое разделение сгенерированного и ручного кода)
- Удобный для diff формат вывода
- Согласованность в различных средах разработки

Этот генератор представляет собой полное решение для быстрой разработки типобезопасных, полнофункциональных приложений из определений схемы Prisma, устраняя шаблонный код при сохранении гибкости для кастомизации.