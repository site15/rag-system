// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

datasource db {
  provider   = "postgresql"
  extensions = [vector]
}

generator backendClient {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  moduleFormat    = "cjs"
  previewFeatures = ["postgresqlExtensions"]
}

generator frontendClient {
  provider        = "prisma-client"
  output          = "../../frontend/src/generated/prisma"
  moduleFormat    = "cjs"
  previewFeatures = ["postgresqlExtensions"]
}

generator prismaClassGenerator {
  prismaClientImportPath          = "../prisma/client"
  provider                        = "ts-node ../prisma-generator-nestjs-dto/src/cli.ts"
  output                          = "../src/generated/rest"
  frontendOutput                  = "../frontend/src/generated"
  annotateAllDtoProperties        = "true"
  classValidation                 = "true"
  createDtoPrefix                 = "Create"
  definiteAssignmentAssertion     = "true"
  dtoSuffix                       = "Dto"
  entityPrefix                    = ""
  entitySuffix                    = ""
  exportRelationModifierClasses   = "true"
  fileNamingStyle                 = "kebab"
  flatResourceStructure           = "false"
  generateControllers             = "true"
  generateDataProviders           = "true"
  generateForms                   = "true"
  generateLists                   = "true"
  moduleName                      = "metrics"
  noDependencies                  = "false"
  outputToNestJsResourceStructure = "false"
  prettier                        = "true"
  reExport                        = "false"
  updateDtoPrefix                 = "Update"
}

model AuthUser {
  id               String   @id(map: "PK_AUTH_USER") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  anonymousId      String?
  supabaseUserId   String?
  supabaseUserData Json?
  isActive         Boolean?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  AuthApiKey  AuthApiKey[]
  AuthSession AuthSession[]
  ChatDialog  ChatDialog[]
  ChatMessage ChatMessage[]

  @@unique(name: "uqSupabaseUserId", [supabaseUserId], map: "UQ_AUTH_USER__SUPABASE_USER_ID")
}

model AuthApiKey {
  id       String   @id(map: "PK_AUTH_API_KEY") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String   @db.Uuid
  apiKey   String?  @db.VarChar(255)
  isActive Boolean?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  AuthUser AuthUser @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_AUTH_API_KEY__USER_ID")

  @@unique(name: "uqApiKey", [apiKey], map: "UQ_AUTH_API_KEY__API_KEY")
  @@index([userId], map: "IDX_AUTH_API_KEY__USER_ID")
}

model AuthSession {
  id       String   @id(map: "PK_AUTH_SESSION") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId   String   @db.Uuid
  isActive Boolean?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  AuthUser AuthUser @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_AUTH_SESSION__USER_ID")

  @@index([userId], map: "IDX_AUTH_SESSION__USER_ID")
}

model ChatPrompt {
  id     String  @id(map: "PK_CHAT_PROMPTS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  key    String? @db.VarChar(255)
  prompt String? @db.Text

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  @@index([key], map: "IDX_CHAT_PROMPTS__KEY")
  @@index([prompt], map: "IDX_CHAT_PROMPTS__PROMPT")
}

model ChatDocumentEmbedding {
  id                 String                       @id(map: "PK_CHAT_DOCUMENT_EMBEDDINGS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  content            String                       @db.Text
  embedding384       Unsupported("vector(384)")?
  embedding768       Unsupported("vector(768)")?
  embedding1024      Unsupported("vector(1024)")?
  embedding1536      Unsupported("vector(1536)")?
  embedding3072      Unsupported("vector(3072)")?
  graphContent       String?                      @db.Text
  graphEmbedding384  Unsupported("vector(384)")?
  graphEmbedding768  Unsupported("vector(768)")?
  graphEmbedding1024 Unsupported("vector(1024)")?
  graphEmbedding1536 Unsupported("vector(1536)")?
  graphEmbedding3072 Unsupported("vector(3072)")?
  metadata           Json?
  contentHash        String                       @db.VarChar(64)
  provider           String?                      @db.VarChar(50)
  model              String?                      @db.VarChar(100)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  ChatMessageDocumentEmbedding ChatMessageDocumentEmbedding[]

  @@index([contentHash], map: "IDX_CHAT_DOCUMENT_EMBEDDINGS__CONTENT_HASH")
}

model ChatDialog {
  id                  String  @id(map: "PK_CHAT_DIALOGS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId              String  @db.Uuid
  title               String? @db.VarChar(255)
  summary             String? @db.Text
  consecutiveFailures Int     @default(0)
  isFailed            Boolean @default(false)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  AuthUser       AuthUser         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_CHAT_DIALOGS__USER_ID")
  ChatMessage    ChatMessage[]
  ChatLlmRequest ChatLlmRequest[]

  @@index([userId], map: "IDX_CHAT_DIALOGS__USER_ID")
  @@index([consecutiveFailures], map: "IDX_CHAT_DIALOGS__CONSECUTIVE_FAILURES")
  @@index([isFailed], map: "IDX_CHAT_DIALOGS__IS_FAILED")
}

model ChatMessage {
  id                        String   @id(map: "PK_CHAT_MESSAGES") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId                    String   @db.Uuid
  question                  String   @db.Text
  answer                    String   @db.Text
  dialogId                  String?  @db.Uuid
  isFound                   Boolean  @default(true)
  category                  String?  @db.VarChar(50)
  transformedQuestion       String?  @db.Text
  transformedEmbeddingQuery String?  @db.Text
  provider                  String?  @db.VarChar(50)
  model                     String?  @db.VarChar(100)
  temperature               Decimal? @db.Decimal(3, 2)
  isGoodResponse            Boolean  @default(false)
  isBadResponse             Boolean  @default(false)
  trace                     Json?

  createdAt DateTime  @default(now()) @db.Timestamp(6)
  updatedAt DateTime  @default(now()) @db.Timestamp(6)
  deletedAt DateTime? @db.Timestamp(6)

  AuthUser AuthUser    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_CHAT_MESSAGES__USER_ID")
  dialog   ChatDialog? @relation(fields: [dialogId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "FK_CHAT_MESSAGES__DIALOG_ID")

  ChatMessageDocumentEmbedding ChatMessageDocumentEmbedding[]
  ChatLlmRequest               ChatLlmRequest[]

  @@index([userId], map: "IDX_CHAT_MESSAGES__USER_ID")
  @@index([dialogId], map: "IDX_CHAT_MESSAGES__DIALOG_ID")
  @@index([isFound], map: "IDX_CHAT_MESSAGES__IS_FOUND")
  @@index([category], map: "IDX_CHAT_MESSAGES__CATEGORY")
  @@index([provider], map: "IDX_CHAT_MESSAGES__PROVIDER")
  @@index([model], map: "IDX_CHAT_MESSAGES__MODEL")
  @@index([isGoodResponse], map: "IDX_CHAT_MESSAGES__IS_GOOD_RESPONSE")
  @@index([isBadResponse], map: "IDX_CHAT_MESSAGES__IS_BAD_RESPONSE")
}

model ChatMessageDocumentEmbedding {
  id                  String   @id(map: "PK_CHAT_MESSAGE_DOCUMENT_EMBEDDINGS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  messageId           String?  @db.Uuid
  embeddingDocumentId String?  @db.Uuid
  isFound             Boolean  @default(false)
  relevanceScore      Decimal? @db.Decimal(3, 2)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  chatHistory       ChatMessage?           @relation(fields: [messageId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_CHAT_MESSAGE_DOCUMENT_EMBEDDINGS__MESSAGE_ID")
  embeddingDocument ChatDocumentEmbedding? @relation(fields: [embeddingDocumentId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "FK_CHAT_MESSAGE_DOCUMENT_EMBEDDINGS__EMBEDDING_DOCUMENT_ID")

  @@index([messageId], map: "IDX_CHAT_MESSAGE_DOCUMENT_EMBEDDINGS__MESSAGE_ID")
  @@index([embeddingDocumentId], map: "IDX_CHAT_MESSAGE_DOCUMENT_EMBEDDINGS__EMBEDDING_DOCUMENT_ID")
  @@index([isFound], map: "IDX_CHAT_MESSAGE_DOCUMENT_EMBEDDINGS__IS_FOUND")
}

model ChatLlmRequest {
  id              String   @id(map: "PK_CHAT_LLM_REQUESTS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  request         String   @db.Text
  response        String   @db.Text
  requestLength   Int
  responseLength  Int
  executionTimeMs Int
  provider        String   @db.VarChar(50)
  model           String   @db.VarChar(100)
  temperature     Decimal? @db.Decimal(3, 2)
  isSuccess       Boolean  @default(true) @map("success")
  errorMessage    String?  @db.Text
  dialogId        String?  @db.Uuid
  messageId       String?  @db.Uuid

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  dialog  ChatDialog?  @relation(fields: [dialogId], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "FK_CHAT_LLM_REQUESTS__DIALOG_ID")
  history ChatMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull, onUpdate: NoAction, map: "FK_CHAT_LLM_REQUESTS__MESSAGE_ID")

  @@index([createdAt], map: "IDX_CHAT_LLM_REQUESTS__CREATED_AT")
  @@index([provider], map: "IDX_CHAT_LLM_REQUESTS__PROVIDER")
  @@index([isSuccess], map: "IDX_CHAT_LLM_REQUESTS__IS_SUCCESS")
  @@index([provider, model], map: "IDX_CHAT_LLM_REQUESTS__PROVIDER_MODEL")
  @@index([dialogId], map: "IDX_CHAT_LLM_REQUESTS__DIALOG_ID")
  @@index([messageId], map: "IDX_CHAT_LLM_REQUESTS__MESSAGE_ID")
  @@index([dialogId, messageId], map: "IDX_CHAT_LLM_REQUESTS__DIALOG_HISTORY")
  @@index([createdAt, dialogId], map: "IDX_CHAT_LLM_REQUESTS__CREATED_DIALOG")
}

model ChatLlmModel {
  id            String    @id(map: "PK_CHAT_LLM_MODELS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  provider      String    @db.VarChar(50)
  model         String    @db.VarChar(100)
  temperature   Decimal?  @db.Decimal(3, 2)
  chunkSize     Int?
  startTime     DateTime? @default(now()) @db.Timestamptz(6)
  endTime       DateTime? @db.Timestamptz(6)
  status        String    @default("running") @db.VarChar(20)
  lastRequestId String?   @unique @db.Uuid
  isActive      Boolean?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  @@unique(name: "uqConfig", [provider, model, temperature, chunkSize], map: "UK_CHAT_LLM_MODELS__CONFIG")
  @@index([provider], map: "IDX_CHAT_LLM_MODELS__PROVIDER")
  @@index([model], map: "IDX_CHAT_LLM_MODELS__MODEL")
  @@index([status], map: "IDX_CHAT_LLM_MODELS__STATUS")
  @@index([startTime], map: "IDX_CHAT_LLM_MODELS__START_TIME")
  @@index([endTime], map: "IDX_CHAT_LLM_MODELS__END_TIME")
  @@index([provider, model], map: "IDX_CHAT_LLM_MODELS__PROVIDER_MODEL")
  @@index([status, startTime], map: "IDX_CHAT_LLM_MODELS__STATUS_TIME")
  @@index([lastRequestId], map: "IDX_CHAT_LLM_MODELS__LAST_REQUEST_ID")
  @@index([status, lastRequestId], map: "IDX_CHAT_LLM_MODELS__STATUS_LAST_REQUEST_ID")
}

model ChatEmbeddingModel {
  id        String  @id(map: "PK_CHAT_EMBEDDING_MODELS") @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String  @db.VarChar(100)
  provider  String  @db.VarChar(50)
  model     String  @db.VarChar(100)
  dimension Int
  isActive  Boolean @default(true)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  @@unique(name: "uqDimension", [dimension], map: "UK_CHAT_EMBEDDING_MODELS__DIMENSION")
  @@index([provider], map: "IDX_CHAT_EMBEDDING_MODELS__PROVIDER")
  @@index([isActive], map: "IDX_CHAT_EMBEDDING_MODELS__IS_ACTIVE")
  @@index([provider, model], map: "IDX_CHAT_EMBEDDING_MODELS__PROVIDER_MODEL")
}
