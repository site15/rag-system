
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lite-версия мигратора Flyway для PostgreSQL на TypeScript</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .article-header { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
    .title { font-size: 24px; font-weight: bold; margin: 0; }
    .pub-date { color: #666; font-size: 14px; margin: 5px 0; }
    .link { color: #007bff; font-size: 14px; margin: 5px 0; }
    .content { line-height: 1.6; }
    .original-description { color: #666; font-style: italic; margin: 10px 0; padding: 10px; background-color: #f9f9f9; }
  </style>
</head>
<body>
  <div class="article-header">
    <h1 class="title">Lite-версия мигратора Flyway для PostgreSQL на TypeScript</h1>
    <div class="pub-date">Дата публикации: Thu, 16 Jan 2025 07:04:28 GMT</div>
    <div class="link"><a href="https://habr.com/ru/articles/874028/?utm_campaign=874028&utm_source=habrahabr&utm_medium=rss" target="_blank">Оригинал статьи</a></div>
  </div>
  <div class="original-description">
    <strong>Описание из RSS:</strong>
    <img src="https://habrastorage.org/getpro/habr/upload_files/67f/130/3f3/67f1303f35882f1d9e46aac398430828.png" /><p>Так как я активно использую возможности <code>Flyway</code>, такие как <code>repeatable migrations</code> и <code>callbacks</code>, и не хочу от них отказываться, а аналогов этих функций в других системах миграции нет, я решил написать собственный лёгкий клон <code>Flyway</code> на <code>Node.js</code> для <code>PostgreSQL</code>.</p> <a href="https://habr.com/ru/articles/874028/?utm_campaign=874028&amp;utm_source=habrahabr&amp;utm_medium=rss#habracut">Читать далее</a>
  </div>
  <div class="content">
    <!--[--><div class="tm-article-presenter__header"><!--[--><!--]--><div class="article-snippet tm-article-presenter__snippet" data-v-222e9ad4=""><!--[--><!--]--><div class="meta-container" data-v-222e9ad4=""><div class="meta" data-v-222e9ad4=""><span class="tm-user-info author" data-v-222e9ad4=""><a href="/ru/users/kaufmanendy/" class="tm-user-info__userpic" data-test-id="user-info-pic"><!--[--><div class="tm-entity-image"><img alt="" class="tm-entity-image__pic" height="24" src="//habrastorage.org/r/w48/getpro/habr/avatars/908/d3c/99c/908d3c99cc4cb5aedaef2173d8b473ae.jpg" width="24"></div><!--]--></a><span class="tm-user-info__user tm-user-info__user_appearance-default" data-test-id="user-info-description"><a href="/ru/users/kaufmanendy/" class="tm-user-info__username" data-test-id="user-info-username"><!--[-->kaufmanendy<!--]--></a><!----><!--[--><span class="tm-article-datetime-published" data-v-222e9ad4=""><time data-allow-mismatch="" datetime="2025-01-16T07:04:28.000Z" title="2025-01-16, 07:04">16  янв   в 07:04</time></span><!--]--></span></span></div><div class="controls" data-v-222e9ad4=""><!----><!----><!----><!----></div></div><h1 class="tm-title tm-title_h1" lang="ru" data-test-id="articleTitle" data-v-222e9ad4=""><span>Lite-версия мигратора Flyway для PostgreSQL на TypeScript</span></h1><div class="stats" data-test-id="articleStats" data-v-222e9ad4=""><div class="tm-article-complexity tm-article-complexity_complexity-medium" data-v-222e9ad4=""><span class="tm-svg-icon__wrapper tm-article-complexity__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Уровень сложности</title><use xlink:href="/img/megazord-v28.cba4c116..svg#complexity-medium"></use></svg></span><span class="tm-article-complexity__label">Средний</span></div><div class="tm-article-reading-time" data-v-222e9ad4=""><span class="tm-svg-icon__wrapper tm-article-reading-time__icon"><svg class="tm-svg-img tm-svg-icon" height="24" width="24"><title>Время на прочтение</title><use xlink:href="/img/megazord-v28.cba4c116..svg#clock"></use></svg></span><span class="tm-article-reading-time__label">4 мин</span></div><span class="tm-icon-counter tm-data-icons__item reach-counter" data-v-222e9ad4=""><svg class="tm-svg-img tm-icon-counter__icon" height="24" width="24"><title>Охват и читатели</title><use xlink:href="/img/megazord-v28.cba4c116..svg#counter-views"></use></svg><span class="tm-icon-counter__value" title="767">767</span></span></div><div class="tm-publication-hubs__container" data-test-id="articleHubsList" data-v-222e9ad4=""><div class="tm-publication-hubs"><!--[--><span class="tm-publication-hub__link-container"><a href="/ru/hubs/typescript/" class="tm-publication-hub__link"><!--[--><span>TypeScript</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб"> * </span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/postgresql/" class="tm-publication-hub__link"><!--[--><span>PostgreSQL</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб"> * </span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/db_admins/" class="tm-publication-hub__link"><!--[--><span>Базы данных</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб"> * </span><!--]--></a></span><span class="tm-publication-hub__link-container"><a href="/ru/hubs/nodejs/" class="tm-publication-hub__link"><!--[--><span>Node.JS</span><span class="tm-article-snippet__profiled-hub" title="Профильный хаб"> * </span><!--]--></a></span><!--]--></div></div><div class="tm-article-labels" data-test-id="articleLabels" data-v-222e9ad4="" data-v-bfa2437b=""><div class="tm-article-labels__container" data-v-bfa2437b=""><!----><!--[--><div class="tm-publication-label tm-publication-label_variant-tutorial" data-v-bfa2437b=""><span>Туториал</span></div><!--[--><!--]--><!--]--></div></div><!----><!----><!--teleport start--><!--teleport end--></div></div><!--[--><!----><div class="article-body" data-gallery-root="" lang="ru" data-v-aad06d04=""><div data-v-aad06d04=""><!--[--><!--]--></div><div id="post-content-body" data-v-aad06d04=""><div><div class="article-formatted-body article-formatted-body article-formatted-body_version-2"><div xmlns="http://www.w3.org/1999/xhtml"><h3>Описание</h3><p>В своих проектах для управления миграциями баз данных я всегда использую <a href="https://documentation.red-gate.com/fd/installers-172490864.html" rel="noopener noreferrer nofollow">Flyway</a>, включая некоторые важные компоненты его экосистемы:</p><ol><li><p><a href="https://documentation.red-gate.com/fd/versioned-migrations-273973333.html" rel="noopener noreferrer nofollow">Versioned migrations</a> — это стандартные миграции, которые применяются последовательно друг за другом.</p></li><li><p><a href="https://documentation.red-gate.com/fd/repeatable-migrations-273973335.html" rel="noopener noreferrer nofollow">Repeatable migrations</a> — это повторяемые миграции, например, скрипты для создания процедур. Они позволяют отслеживать историю изменений с помощью Git.</p></li><li><p><a href="https://documentation.red-gate.com/fd/callbacks-275218509.html" rel="noopener noreferrer nofollow">Callbacks</a> — это различные хуки, которые срабатывают в определённое время. Например, можно создать скрипт <code>beforeMigrate__init_types.sql</code>, в котором описаны все кастомные типы, используемые в базе данных. Мигратор сначала выполняет этот скрипт, а затем остальные операции.</p></li></ol><p>Я бэкенд разработчик на <code>Node.js</code> и стараюсь использовать консольные утилиты написанные под <code>Node.js</code>, в случаи с <code>Flyway</code> использую <code>Node.js</code>-обёртку — <a href="https://www.npmjs.com/package/node-flywaydb" rel="noopener noreferrer nofollow">node-flywaydb</a>.</p><p>Этот инструмент очень прост в использовании: при запуске он скачивает оригинальную <code>Java</code>-утилиту и запускает её, поэтому для работы требуется наличие <code>JVM</code> на машине.</p><h3>Проблема</h3><p>Когда мы создаем <code>Docker</code>-образы, предназначенные для запуска миграций базы данных, нам приходится включать в них <code>JVM</code>, что значительно увеличивает размер образа и замедляет весь <code>CI/CD</code>-процесс.</p><h3>Возможные решения</h3><ol><li><p>Использовать <code>Node.js</code>-миграторы (например: <code>db-migrate</code>, <code>umzug</code>, <code>pg-migrate</code>).</p></li><li><p>Использовать миграторы, встроенные в <code>ORM</code>, применяемую в проекте (например: <code>prisma</code>, <code>typeorm</code>).</p></li><li><p>Написать лёгкий клон <code>Flyway</code> на <code>Node.js</code> для одного типа базы данных (<code>PostgreSQL</code>).</p></li></ol><h3>Принятое решение</h3><p>Поскольку я активно использую возможности <code>Flyway</code>, такие как <code>repeatable migrations</code> и <code>callbacks</code>, и не хочу отказываться от них, так как аналоги этих функций отсутствуют в других системах миграции, оптимальным решением стало создание собственного легкого клона <code>Flyway</code> на <code>Node.js</code> для работы с <code>PostgreSQL</code>.</p><h3>Этапы разработки</h3><ol><li><p><a href="https://documentation.red-gate.com/fd/versioned-migrations-273973333.html" rel="noopener noreferrer nofollow">Versioned migrations</a> — <strong>выполнено</strong>.</p></li><li><p><a href="https://documentation.red-gate.com/fd/repeatable-migrations-273973335.html" rel="noopener noreferrer nofollow">Repeatable migrations</a> — <strong>выполнено</strong>.</p></li><li><p><a href="https://documentation.red-gate.com/fd/callbacks-275218509.html" rel="noopener noreferrer nofollow">Callbacks</a> — <strong>частично выполнено</strong>, только для <code>versioned</code>.</p></li><li><p><a href="https://documentation.red-gate.com/fd/flyway-schema-history-table-273973417.html" rel="noopener noreferrer nofollow">Flyway schema history table</a> — <strong>частично выполнена</strong>, только для <code>versioned</code> и <code>repeatable</code>.</p></li><li><p><a href="https://documentation.red-gate.com/fd/migration-command-dry-runs-275218517.html" rel="noopener noreferrer nofollow">Migration Command Dry Runs</a> — <strong>выполнено</strong>.</p></li><li><p><a href="https://documentation.red-gate.com/fd/baseline-migrations-273973336.html" rel="noopener noreferrer nofollow">Baseline migrations</a> — не выполнено.</p></li><li><p><a href="https://documentation.red-gate.com/fd/baseline-migrations-273973336.html" rel="noopener noreferrer nofollow">Undo migrations</a> — не выполнено.</p></li><li><p><a href="https://documentation.red-gate.com/fd/script-migrations-273973390.html" rel="noopener noreferrer nofollow">Script migrations</a> — не выполнено.</p></li><li><p><a href="https://documentation.red-gate.com/fd/migration-transaction-handling-273973399.html" rel="noopener noreferrer nofollow">Migration transaction handling</a> — не выполнено.</p></li></ol><p><a href="https://github.com/flyway/flyway/blob/main/documentation/Flyway%20CLI%20and%20API/Concepts/Migrations.md" rel="noopener noreferrer nofollow">Там</a> у них действительно много интересных возможностей, я перечислил только те, которые были наиболее полезными в моей практике.</p><h3>Пример использования</h3><h4>Запуск базы данных</h4><p>Для запуска базы данных выполните следующую команду:</p><pre><code>curl -fsSL https://raw.githubusercontent.com/EndyKaufman/pg-tools/refs/heads/master/docker-compose.yml -o docker-compose.yml
docker compose up -d
</code></pre><p>Результатом будет успешный запуск контейнера PostgreSQL:</p><pre><code>[+] Running 3/3
 ✔ Network pg-tools_default              Created                         0.1s
 ✔ Volume "pg-tools-postgre-sql-volume"  Created                         0.0s
 ✔ Container pg-tools-postgre-sql        Started                         0.2s
</code></pre><h4>Создание миграции</h4><p>Для создания первой миграции выполните следующую команду:</p><pre><code>npx pg-flyway create --name=Init --version=1
echo "CREATE TABLE \"User\"(id uuid NOT NULL DEFAULT uuid_generate_v4() constraint PK_USER primary key,email varchar(20));" &gt; migrations/V1__Init.sql
</code></pre><p>Результатом будет успешное создание миграции:</p><pre><code>[2025-01-15T23:23:53.903] [INFO] create - Name: Init
[2025-01-15T23:23:53.904] [INFO] create - Locations: migrations
[2025-01-15T23:23:53.914] [INFO] create - Migration "migrations/V1__Init.sql" was created successfully!
</code></pre><h4>Применение миграции</h4><p>Для применения созданной миграции выполните следующую команду:</p><pre><code>npx pg-flyway migrate --database-url=postgres://pgtoolsusername:pgtoolspassword@localhost:5432/pgtoolsdatabase?schema=public
</code></pre><p>Результатом будет успешное выполнение миграции:</p><pre><code>[2025-01-16T00:08:39.052] [INFO] migrate - Locations: migrations
[2025-01-16T00:08:39.053] [INFO] migrate - HistoryTable: __migrations
[2025-01-16T00:08:39.053] [INFO] migrate - DatabaseUrl: postgres://pgtoolsusername:pgtoolspassword@localhost:5432/pgtoolsdatabase?schema=public
[2025-01-16T00:08:39.074] [INFO] migrate - Migrations: 1
</code></pre><h4>Просмотр списка выполненных миграций</h4><p>Для просмотра списка выполненных миграций выполните следующую команду:</p><pre><code>npx pg-flyway info --database-url=postgres://pgtoolsusername:pgtoolspassword@localhost:5432/pgtoolsdatabase?schema=public
</code></pre><p>Результатом будет таблица с информацией о выполненных миграциях:</p><pre><code>[2025-01-16T09:15:34.007] [INFO] info - HistoryTable: __migrations
[2025-01-16T09:15:34.008] [INFO] info - DatabaseUrl: postgres://pgtoolsusername:pgtoolspassword@localhost:5432/pgtoolsdatabase?schema=public
[2025-01-16T09:15:34.057] [INFO] info - Migrations: 1
┌───────────┬─────────┬─────────────┬──────┬─────────────────────┬─────────┬──────────┐
│  Category │ Version │ Description │ Type │        Installed On │   State │ Undoable │
├───────────┼─────────┼─────────────┼──────┼─────────────────────┼─────────┼──────────┤
│ Versioned │       1 │        Init │  SQL │ 2025-01-15 20:08:39 │ Success │       No │
└───────────┴─────────┴─────────────┴──────┴─────────────────────┴─────────┴──────────┘
</code></pre><h4>Остановка базы данных</h4><p>Для остановки базы данных выполните следующую команду:</p><pre><code>docker compose down
</code></pre><h3>Планы</h3><p>Основные функции <code>Flyway</code> уже перенесены в <code>Typescript</code>-код, что обеспечивает необходимый функционал для большинства сценариев при работе с миграциями.</p><p>Остальные не портированные функции я планирую переносить по мере наличия свободного времени.</p><p>Буду рад <code>pull</code>-реквестам с новыми функциями и исправлением багов.</p><h3>Ссылки</h3><ul><li><p><a href="https://github.com/EndyKaufman/pg-tools" rel="noopener noreferrer nofollow">https://github.com/EndyKaufman/pg-tools</a> - Репозиторий проекта</p></li><li><p><a href="https://www.npmjs.com/package/pg-flyway" rel="noopener noreferrer nofollow">https://www.npmjs.com/package/pg-flyway</a> - Утилита на NPM</p></li><li><p><a href="https://www.npmjs.com/package/node-flywaydb" rel="noopener noreferrer nofollow">https://www.npmjs.com/package/node-flywaydb</a> - Враппер для <code>Flyway</code> (<code>Java</code>) на <code>NodeJS</code></p></li><li><p><a href="https://documentation.red-gate.com/flyway-concepts-271583830.html" rel="noopener noreferrer nofollow">https://documentation.red-gate.com/flyway-concepts-271583830.html</a> - Документация <code>Flyway</code></p></li></ul></div></div></div><!----><!----></div><!----><!----></div><!--]--><!----><div class="tm-article-presenter__meta" data-test-id="article-meta-links"><div class="tm-separated-list tag-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[flyway]" class="link"><span>flyway</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[database]" class="link"><span>database</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[postgres]" class="link"><span>postgres</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[migrations]" class="link"><span>migrations</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[nodejs]" class="link"><span>nodejs</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%BC%D0%B8%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8]" class="link"><span>миграции</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%BF%D0%BE%D1%81%D1%82%D0%B3%D1%80%D0%B5%D1%81]" class="link"><span>постгрес</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[sql]" class="link"><span>sql</span></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=[%D0%BA%D0%BE%D0%BD%D1%81%D0%BE%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F+%D1%83%D1%82%D0%B8%D0%BB%D0%B8%D1%82%D0%B0]" class="link"><span>консольная утилита</span></a><!--]--></li><!--]--><!----></ul></div><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span><ul class="tm-separated-list__list"><!--[--><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/typescript/" class="link"><!--[--><span>TypeScript</span><!--]--></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/postgresql/" class="link"><!--[--><span>PostgreSQL</span><!--]--></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/db_admins/" class="link"><!--[--><span>Базы данных</span><!--]--></a><!--]--></li><li class="tm-separated-list__item"><!--[--><a href="/ru/hubs/nodejs/" class="link"><!--[--><span>Node.JS</span><!--]--></a><!--]--></li><!--]--><!----></ul></div></div><!----><!--]-->
  </div>
</body>
</html>
        